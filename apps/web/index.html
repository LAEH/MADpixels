<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MADpixels</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --bg: #000000;
            --surface: #0a0a0a;
            --border: #1a1a1a;
            --text: #ffffff;
            --text-dim: #666666;
            --accent: #ff2d6a;
            --accent-glow: rgba(255, 45, 106, 0.4);
            --cyan: #00f0ff;
            --cyan-glow: rgba(0, 240, 255, 0.4);
        }

        body {
            font-family: 'Space Mono', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            min-height: 100dvh;
        }

        /* Header */
        header {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: var(--accent);
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .icon-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
        }
        .icon-btn:active { transform: scale(0.95); }
        .icon-btn:disabled { opacity: 0.2; pointer-events: none; }
        .icon-btn svg { width: 18px; height: 18px; }

        /* Main */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
        }

        /* Gallery View */
        .gallery-view {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .gallery-header {
            text-align: center;
            padding-top: 20px;
        }

        .gallery-title {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--accent), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .gallery-subtitle {
            font-size: 12px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2px;
            border: 1px solid var(--border);
        }

        .gallery-item {
            aspect-ratio: 1;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            background: var(--surface);
        }

        .gallery-item::after {
            content: '';
            position: absolute;
            inset: 0;
            border: 2px solid transparent;
            transition: all 0.15s ease;
            pointer-events: none;
        }

        .gallery-item:hover::after {
            border-color: var(--accent);
            box-shadow: inset 0 0 30px var(--accent-glow);
        }

        .gallery-item:active { opacity: 0.8; }

        .gallery-item canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .gallery-item-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px;
            background: rgba(0,0,0,0.8);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            border-top: 1px solid var(--border);
        }

        .choose-photo-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .choose-photo-btn:hover {
            background: var(--accent);
            color: var(--bg);
            box-shadow: 0 0 30px var(--accent-glow);
        }
        .choose-photo-btn:active { transform: scale(0.98); }
        .choose-photo-btn svg { width: 18px; height: 18px; }

        /* Editor View */
        .editor-view {
            display: none;
            flex-direction: column;
            gap: 20px;
        }

        .editor-view.active { display: flex; }
        .gallery-view.hidden { display: none; }

        .canvas-area {
            aspect-ratio: 1;
            max-height: 50vh;
            background: var(--surface);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .canvas-area:hover {
            border-color: var(--text-dim);
        }

        .canvas-area canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .canvas-hint {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .canvas-area:hover .canvas-hint { opacity: 1; }

        .drop-zone {
            position: absolute;
            inset: 0;
            background: rgba(255, 45, 106, 0.1);
            border: 2px dashed var(--accent);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent);
        }

        .drop-zone.active { display: flex; }

        /* Compare */
        .compare-bar {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 8px 0;
        }

        .compare-bar.visible { display: flex; }

        .compare-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-dim);
            transition: all 0.15s;
        }
        .compare-label.active { color: var(--cyan); }

        .toggle {
            width: 48px;
            height: 24px;
            background: var(--surface);
            border: 1px solid var(--border);
            position: relative;
            cursor: pointer;
            transition: all 0.15s;
        }

        .toggle.on {
            border-color: var(--cyan);
            box-shadow: 0 0 15px var(--cyan-glow);
        }

        .toggle-knob {
            position: absolute;
            width: 18px;
            height: 18px;
            background: var(--text-dim);
            top: 2px;
            left: 2px;
            transition: all 0.15s ease;
        }

        .toggle.on .toggle-knob {
            transform: translateX(24px);
            background: var(--cyan);
        }

        /* Controls */
        .controls {
            border: 1px solid var(--border);
            background: var(--surface);
        }

        .section {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .section:last-child { border-bottom: none; }

        .section-title {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 12px;
        }

        .effects-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .effect-pill {
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            font-family: 'Space Mono', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .effect-pill:hover {
            border-color: var(--text);
            color: var(--text);
        }
        .effect-pill:active { transform: scale(0.96); }
        .effect-pill.active {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }

        .setting-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setting-value {
            font-size: 11px;
            color: var(--cyan);
            min-width: 32px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100px;
            height: 2px;
            background: var(--border);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: var(--cyan);
            cursor: pointer;
            box-shadow: 0 0 10px var(--cyan-glow);
        }

        .apply-btn {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--accent);
            background: var(--accent);
            color: var(--bg);
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .apply-btn:hover {
            box-shadow: 0 0 30px var(--accent-glow);
        }
        .apply-btn:active { transform: scale(0.98); }
        .apply-btn:disabled {
            background: transparent;
            color: var(--text-dim);
            border-color: var(--border);
            box-shadow: none;
        }

        .progress-section {
            display: none;
            padding: 16px;
            text-align: center;
        }

        .progress-section.visible { display: block; }

        .progress-bar {
            height: 2px;
            background: var(--border);
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .progress-text {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-dim);
        }

        .perf-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border: 1px solid var(--border);
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .perf-badge.gpu {
            color: var(--cyan);
            border-color: var(--cyan);
        }

        .hidden { display: none !important; }

        @media (min-width: 768px) {
            main { padding-top: 40px; }
            .canvas-area { max-height: 400px; }
            .gallery-grid { gap: 4px; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .processing .apply-btn { animation: pulse 1s ease infinite; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .gallery-item { animation: fadeIn 0.3s ease backwards; }
        .gallery-item:nth-child(1) { animation-delay: 0s; }
        .gallery-item:nth-child(2) { animation-delay: 0.05s; }
        .gallery-item:nth-child(3) { animation-delay: 0.1s; }
        .gallery-item:nth-child(4) { animation-delay: 0.15s; }

        /* Glitch effect on title hover */
        .gallery-title:hover {
            animation: glitch 0.3s ease;
        }

        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <span class="logo">MADpixels</span>
            <div class="header-actions">
                <button class="icon-btn" id="downloadBtn" disabled title="Save">
                    <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                </button>
            </div>
        </header>

        <main>
            <!-- Gallery View -->
            <div class="gallery-view" id="galleryView">
                <div class="gallery-header">
                    <div class="gallery-title">MADpixels</div>
                    <div class="gallery-subtitle">Select a style or upload</div>
                </div>

                <div class="gallery-grid" id="galleryGrid"></div>

                <button class="choose-photo-btn" id="choosePhotoBtn">
                    <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    Upload
                </button>
            </div>

            <!-- Editor View -->
            <div class="editor-view" id="editorView">
                <div class="canvas-area" id="canvasArea">
                    <canvas id="canvas"></canvas>
                    <canvas id="glCanvas" class="hidden"></canvas>
                    <div class="canvas-hint">tap to change</div>
                    <div class="drop-zone" id="dropZone">Drop file</div>
                </div>

                <div class="compare-bar" id="compareBar">
                    <span class="compare-label" id="labelOriginal">src</span>
                    <div class="toggle on" id="toggle">
                        <div class="toggle-knob"></div>
                    </div>
                    <span class="compare-label active" id="labelProcessed">out</span>
                </div>

                <div class="controls">
                    <div class="section">
                        <div class="section-title">Effect</div>
                        <div class="effects-row" id="effectsRow"></div>
                    </div>

                    <div class="section" id="settingsSection">
                        <div class="section-title">Params</div>
                        <div id="settingsContainer"></div>
                    </div>

                    <div class="progress-section" id="progressSection">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">Processing...</div>
                        <div class="perf-badge" id="perfBadge"></div>
                    </div>

                    <div class="section">
                        <button class="apply-btn" id="applyBtn">Execute</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <input type="file" id="fileInput" accept="image/*" style="display:none">

<script>
// WebGL Processor
class WebGLProcessor {
    constructor() {
        this.canvas = document.getElementById('glCanvas');
        this.gl = this.canvas.getContext('webgl2') || this.canvas.getContext('webgl');
        this.programs = {};
        this.available = !!this.gl;
        if (this.available) this.init();
    }

    init() {
        const gl = this.gl;
        const vert = `attribute vec2 a_position;attribute vec2 a_texCoord;varying vec2 v_texCoord;void main(){gl_Position=vec4(a_position,0,1);v_texCoord=a_texCoord;}`;

        const shaders = {
            invert: `precision mediump float;varying vec2 v_texCoord;uniform sampler2D u_image;void main(){vec4 c=texture2D(u_image,v_texCoord);gl_FragColor=vec4(1.0-c.rgb,c.a);}`,
            boost: `precision mediump float;varying vec2 v_texCoord;uniform sampler2D u_image;uniform vec3 u_boost;vec3 tanh3(vec3 x){vec3 e=exp(2.0*x);return(e-1.0)/(e+1.0);}void main(){vec4 c=texture2D(u_image,v_texCoord);vec3 n=(c.rgb-0.5)*u_boost*4.0;gl_FragColor=vec4((tanh3(n)+1.0)*0.5,c.a);}`,
            blur: `precision mediump float;varying vec2 v_texCoord;uniform sampler2D u_image;uniform vec2 u_res;uniform float u_rad;uniform vec2 u_dir;void main(){vec4 s=vec4(0.0);float t=0.0;for(float i=-20.0;i<=20.0;i+=1.0){float w=exp(-i*i/(2.0*u_rad*u_rad));s+=texture2D(u_image,v_texCoord+u_dir*i/u_res)*w;t+=w;}gl_FragColor=s/t;}`,
            localShuffle: `precision highp float;varying vec2 v_texCoord;uniform sampler2D u_image;uniform vec2 u_res;uniform float u_spread;uniform float u_seed;float hash(vec2 p){return fract(sin(dot(p,vec2(127.1,311.7)))*43758.5453+u_seed);}void main(){float m=max(u_res.x,u_res.y)*u_spread/4.0;float u1=max(0.0001,hash(v_texCoord*u_res));float u2=hash(v_texCoord*u_res+vec2(1.0,0.0));float r=sqrt(-2.0*log(u1));vec2 n=vec2(r*cos(6.28318*u2),r*sin(6.28318*u2))*m/u_res;gl_FragColor=texture2D(u_image,clamp(v_texCoord+n,0.0,1.0));}`,
            gradient: `precision mediump float;varying vec2 v_texCoord;uniform vec4 u_tl,u_tr,u_bl,u_br;void main(){gl_FragColor=mix(mix(u_tl,u_tr,v_texCoord.x),mix(u_bl,u_br,v_texCoord.x),v_texCoord.y);}`
        };

        for (const [name, frag] of Object.entries(shaders)) {
            const vs = gl.createShader(gl.VERTEX_SHADER); gl.shaderSource(vs, vert); gl.compileShader(vs);
            const fs = gl.createShader(gl.FRAGMENT_SHADER); gl.shaderSource(fs, frag); gl.compileShader(fs);
            const prog = gl.createProgram(); gl.attachShader(prog, vs); gl.attachShader(prog, fs); gl.linkProgram(prog);
            this.programs[name] = prog;
        }

        this.posBuf = gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER, this.posBuf);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]), gl.STATIC_DRAW);
        this.texBuf = gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER, this.texBuf);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([0,1,1,1,0,0,0,0,1,1,1,0]), gl.STATIC_DRAW);
    }

    createTexture(img) {
        const gl = this.gl, tex = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, tex);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);
        return tex;
    }

    render(prog, w, h, setup) {
        const gl = this.gl;
        this.canvas.width = w; this.canvas.height = h;
        gl.viewport(0, 0, w, h); gl.useProgram(prog);
        const pLoc = gl.getAttribLocation(prog, 'a_position');
        gl.bindBuffer(gl.ARRAY_BUFFER, this.posBuf); gl.enableVertexAttribArray(pLoc); gl.vertexAttribPointer(pLoc, 2, gl.FLOAT, false, 0, 0);
        const tLoc = gl.getAttribLocation(prog, 'a_texCoord');
        gl.bindBuffer(gl.ARRAY_BUFFER, this.texBuf); gl.enableVertexAttribArray(tLoc); gl.vertexAttribPointer(tLoc, 2, gl.FLOAT, false, 0, 0);
        setup(gl, prog); gl.drawArrays(gl.TRIANGLES, 0, 6);
    }

    getImageData() {
        const gl = this.gl, w = this.canvas.width, h = this.canvas.height;
        const px = new Uint8Array(w * h * 4);
        gl.readPixels(0, 0, w, h, gl.RGBA, gl.UNSIGNED_BYTE, px);
        const flip = new Uint8ClampedArray(px.length);
        for (let y = 0; y < h; y++) flip.set(px.subarray((h-1-y)*w*4, (h-y)*w*4), y*w*4);
        return new ImageData(flip, w, h);
    }

    gradient(w, h, colors) {
        this.render(this.programs.gradient, w, h, (gl, p) => {
            gl.uniform4f(gl.getUniformLocation(p, 'u_tl'), colors.tl[0], colors.tl[1], colors.tl[2], 1);
            gl.uniform4f(gl.getUniformLocation(p, 'u_tr'), colors.tr[0], colors.tr[1], colors.tr[2], 1);
            gl.uniform4f(gl.getUniformLocation(p, 'u_bl'), colors.bl[0], colors.bl[1], colors.bl[2], 1);
            gl.uniform4f(gl.getUniformLocation(p, 'u_br'), colors.br[0], colors.br[1], colors.br[2], 1);
        });
        return this.getImageData();
    }

    invert(img) { const t = this.createTexture(img); this.render(this.programs.invert, img.width, img.height, (gl, p) => { gl.activeTexture(gl.TEXTURE0); gl.bindTexture(gl.TEXTURE_2D, t); gl.uniform1i(gl.getUniformLocation(p, 'u_image'), 0); }); this.gl.deleteTexture(t); return this.getImageData(); }
    boost(img, r, g, b) { const t = this.createTexture(img); this.render(this.programs.boost, img.width, img.height, (gl, p) => { gl.activeTexture(gl.TEXTURE0); gl.bindTexture(gl.TEXTURE_2D, t); gl.uniform1i(gl.getUniformLocation(p, 'u_image'), 0); gl.uniform3f(gl.getUniformLocation(p, 'u_boost'), r, g, b); }); this.gl.deleteTexture(t); return this.getImageData(); }
    blur(img, rad) { const gl = this.gl; let t = this.createTexture(img); this.render(this.programs.blur, img.width, img.height, (gl, p) => { gl.activeTexture(gl.TEXTURE0); gl.bindTexture(gl.TEXTURE_2D, t); gl.uniform1i(gl.getUniformLocation(p, 'u_image'), 0); gl.uniform2f(gl.getUniformLocation(p, 'u_res'), img.width, img.height); gl.uniform1f(gl.getUniformLocation(p, 'u_rad'), rad); gl.uniform2f(gl.getUniformLocation(p, 'u_dir'), 1, 0); }); const mid = this.getImageData(); gl.deleteTexture(t); t = this.createTexture(mid); this.render(this.programs.blur, img.width, img.height, (gl, p) => { gl.activeTexture(gl.TEXTURE0); gl.bindTexture(gl.TEXTURE_2D, t); gl.uniform1i(gl.getUniformLocation(p, 'u_image'), 0); gl.uniform2f(gl.getUniformLocation(p, 'u_res'), img.width, img.height); gl.uniform1f(gl.getUniformLocation(p, 'u_rad'), rad); gl.uniform2f(gl.getUniformLocation(p, 'u_dir'), 0, 1); }); gl.deleteTexture(t); return this.getImageData(); }
    localShuffle(img, spread) { const t = this.createTexture(img); this.render(this.programs.localShuffle, img.width, img.height, (gl, p) => { gl.activeTexture(gl.TEXTURE0); gl.bindTexture(gl.TEXTURE_2D, t); gl.uniform1i(gl.getUniformLocation(p, 'u_image'), 0); gl.uniform2f(gl.getUniformLocation(p, 'u_res'), img.width, img.height); gl.uniform1f(gl.getUniformLocation(p, 'u_spread'), spread); gl.uniform1f(gl.getUniformLocation(p, 'u_seed'), Math.random() * 1000); }); this.gl.deleteTexture(t); return this.getImageData(); }
}

// App State
const effects = [
    { id: 'localShuffle', name: 'Disperse', gpu: true },
    { id: 'globalShuffle', name: 'Shuffle', gpu: false },
    { id: 'binedShuffle', name: 'Blocks', gpu: false },
    { id: 'invert', name: 'Invert', gpu: true },
    { id: 'boost', name: 'Boost', gpu: true },
    { id: 'gaussianBlur', name: 'Blur', gpu: true }
];

const settingsConfig = {
    globalShuffle: [{ id: 'size', name: 'Size', min: 256, max: 1024, default: 512, step: 128 }],
    binedShuffle: [{ id: 'size', name: 'Size', min: 256, max: 1024, default: 512, step: 128 }, { id: 'block', name: 'Block', min: 8, max: 64, default: 16, step: 8 }],
    localShuffle: [{ id: 'spread', name: 'Intensity', min: 0, max: 100, default: 25, step: 5 }],
    boost: [{ id: 'red', name: 'Warm', min: 0, max: 100, default: 40, step: 5 }, { id: 'green', name: 'Tint', min: 0, max: 100, default: 30, step: 5 }, { id: 'blue', name: 'Cool', min: 0, max: 100, default: 20, step: 5 }],
    gaussianBlur: [{ id: 'radius', name: 'Radius', min: 1, max: 30, default: 8, step: 1 }],
    invert: []
};

// Gallery presets - punk color schemes
const presets = [
    { name: 'Neon', colors: { tl: [1, 0.1, 0.4], tr: [0, 0.9, 1], bl: [0.1, 0, 0.2], br: [0.2, 0, 0.4] } },
    { name: 'Void', colors: { tl: [0.05, 0.05, 0.1], tr: [0.1, 0, 0.15], bl: [0, 0, 0], br: [0.05, 0.02, 0.08] } },
    { name: 'Acid', colors: { tl: [0.7, 1, 0], tr: [0, 1, 0.5], bl: [0.2, 0.3, 0], br: [0, 0.4, 0.2] } },
    { name: 'Burn', colors: { tl: [1, 0.3, 0], tr: [1, 0.6, 0], bl: [0.3, 0, 0], br: [0.5, 0.1, 0] } }
];

let state = { effect: 'localShuffle', settings: {}, original: null, processed: null, processing: false };

const $ = id => document.getElementById(id);
const canvas = $('canvas'), ctx = canvas.getContext('2d', { willReadFrequently: true });
const gpu = new WebGLProcessor();

// Generate gallery previews
function generateGallery() {
    const grid = $('galleryGrid');
    grid.innerHTML = '';

    presets.forEach((preset, i) => {
        const item = document.createElement('div');
        item.className = 'gallery-item';

        const c = document.createElement('canvas');
        c.width = 200; c.height = 200;
        const imgData = gpu.gradient(200, 200, preset.colors);
        c.getContext('2d').putImageData(imgData, 0, 0);

        const label = document.createElement('div');
        label.className = 'gallery-item-label';
        label.textContent = preset.name;

        item.appendChild(c);
        item.appendChild(label);

        item.onclick = () => {
            const fullImg = gpu.gradient(512, 512, preset.colors);
            state.original = fullImg;
            state.processed = null;
            showEditor();
        };

        grid.appendChild(item);
    });
}

function showEditor() {
    $('galleryView').classList.add('hidden');
    $('editorView').classList.add('active');
    display(state.original);
    $('compareBar').classList.remove('visible');
    $('downloadBtn').disabled = true;
}

function showGallery() {
    $('galleryView').classList.remove('hidden');
    $('editorView').classList.remove('active');
}

function renderEffects() {
    $('effectsRow').innerHTML = effects.map(e =>
        `<button class="effect-pill ${e.id === state.effect ? 'active' : ''}" data-id="${e.id}">${e.name}</button>`
    ).join('');
    $('effectsRow').querySelectorAll('.effect-pill').forEach(btn => {
        btn.onclick = () => { state.effect = btn.dataset.id; renderEffects(); renderSettings(); };
    });
}

function renderSettings() {
    const cfg = settingsConfig[state.effect] || [];
    if (!cfg.length) { $('settingsSection').classList.add('hidden'); return; }
    $('settingsSection').classList.remove('hidden');
    $('settingsContainer').innerHTML = cfg.map(s => {
        const val = state.settings[s.id] ?? s.default;
        return `<div class="setting-item"><span class="setting-label">${s.name}</span><div class="setting-control"><input type="range" id="r-${s.id}" min="${s.min}" max="${s.max}" value="${val}" step="${s.step}"><span class="setting-value" id="v-${s.id}">${val}</span></div></div>`;
    }).join('');
    cfg.forEach(s => {
        state.settings[s.id] = state.settings[s.id] ?? s.default;
        const inp = $(`r-${s.id}`), val = $(`v-${s.id}`);
        inp.oninput = () => { state.settings[s.id] = +inp.value; val.textContent = inp.value; };
    });
}

function loadImage(file) {
    const reader = new FileReader();
    reader.onload = e => {
        const img = new Image();
        img.onload = () => {
            canvas.width = img.width; canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            state.original = ctx.getImageData(0, 0, canvas.width, canvas.height);
            state.processed = null;
            showEditor();
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function display(data) {
    if (!data) return;
    canvas.width = data.width; canvas.height = data.height;
    ctx.putImageData(data, 0, 0);
}

function updateProgress(pct) {
    $('progressFill').style.width = pct + '%';
    $('progressText').textContent = pct < 100 ? 'Processing...' : 'Complete';
}

function resize(img, w, h) {
    const c1 = document.createElement('canvas'); c1.width = img.width; c1.height = img.height; c1.getContext('2d').putImageData(img, 0, 0);
    const c2 = document.createElement('canvas'); c2.width = w; c2.height = h; c2.getContext('2d').drawImage(c1, 0, 0, w, h);
    return c2.getContext('2d').getImageData(0, 0, w, h);
}

async function chunk(total, size, fn) {
    return new Promise(resolve => {
        let i = 0;
        function step() {
            const end = Math.min(i + size, total);
            fn(i, end); i = end; updateProgress(Math.round(i / total * 100));
            i < total ? requestAnimationFrame(step) : resolve();
        }
        requestAnimationFrame(step);
    });
}

async function globalShuffle() {
    const s = state.settings.size || 512, img = resize(state.original, s, s), d = new Uint8ClampedArray(img.data), n = s * s;
    const idx = new Uint32Array(n); for (let i = 0; i < n; i++) idx[i] = i;
    await chunk(n, 50000, (a, b) => { for (let i = b - 1; i >= a && i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [idx[i], idx[j]] = [idx[j], idx[i]]; } });
    const out = new Uint8ClampedArray(n * 4);
    for (let i = 0; i < n; i++) { const src = idx[i] * 4, dst = i * 4; out[dst] = d[src]; out[dst+1] = d[src+1]; out[dst+2] = d[src+2]; out[dst+3] = d[src+3]; }
    return new ImageData(out, s, s);
}

async function binedShuffle() {
    const s = state.settings.size || 512, b = state.settings.block || 16, img = resize(state.original, s, s), d = new Uint8ClampedArray(img.data);
    const bx = Math.floor(s / b), by = Math.floor(s / b), total = bx * by;
    await chunk(total, 50, (start, end) => {
        for (let bi = start; bi < end; bi++) {
            const x0 = (bi % bx) * b, y0 = Math.floor(bi / bx) * b;
            const px = [];
            for (let y = 0; y < b; y++) for (let x = 0; x < b; x++) { const i = ((y0 + y) * s + x0 + x) * 4; px.push([d[i], d[i+1], d[i+2], d[i+3]]); }
            for (let i = px.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [px[i], px[j]] = [px[j], px[i]]; }
            let pi = 0;
            for (let y = 0; y < b; y++) for (let x = 0; x < b; x++) { const i = ((y0 + y) * s + x0 + x) * 4; d[i] = px[pi][0]; d[i+1] = px[pi][1]; d[i+2] = px[pi][2]; d[i+3] = px[pi][3]; pi++; }
        }
    });
    return new ImageData(d, s, s);
}

async function applyEffect() {
    if (state.processing || !state.original) return;
    state.processing = true;
    document.body.classList.add('processing');
    $('applyBtn').disabled = true;
    $('progressSection').classList.add('visible');
    updateProgress(0);

    const t0 = performance.now();
    let result, usedGPU = false;
    const eff = effects.find(e => e.id === state.effect);

    try {
        if (gpu.available && eff?.gpu) {
            usedGPU = true;
            if (state.effect === 'invert') result = gpu.invert(state.original);
            else if (state.effect === 'boost') result = gpu.boost(state.original, (state.settings.red ?? 40) / 100, (state.settings.green ?? 30) / 100, (state.settings.blue ?? 20) / 100);
            else if (state.effect === 'gaussianBlur') result = gpu.blur(state.original, state.settings.radius || 8);
            else if (state.effect === 'localShuffle') result = gpu.localShuffle(state.original, (state.settings.spread || 25) / 100);
        }
        if (!result) {
            usedGPU = false;
            if (state.effect === 'globalShuffle') result = await globalShuffle();
            else if (state.effect === 'binedShuffle') result = await binedShuffle();
        }

        const ms = (performance.now() - t0).toFixed(0);
        $('perfBadge').className = 'perf-badge' + (usedGPU ? ' gpu' : '');
        $('perfBadge').innerHTML = (usedGPU ? '<svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>' : '') + ms + 'ms';

        state.processed = result;
        display(result);
        $('downloadBtn').disabled = false;
        $('compareBar').classList.add('visible');
        $('toggle').classList.add('on');
        $('labelOriginal').classList.remove('active');
        $('labelProcessed').classList.add('active');
    } catch (e) { console.error(e); }

    updateProgress(100);
    setTimeout(() => {
        $('progressSection').classList.remove('visible');
        state.processing = false;
        document.body.classList.remove('processing');
        $('applyBtn').disabled = false;
    }, 400);
}

// Events
$('choosePhotoBtn').onclick = () => $('fileInput').click();
$('canvasArea').onclick = () => $('fileInput').click();
$('fileInput').onchange = e => e.target.files[0] && loadImage(e.target.files[0]);

$('canvasArea').ondragover = e => { e.preventDefault(); $('dropZone').classList.add('active'); };
$('canvasArea').ondragleave = () => $('dropZone').classList.remove('active');
$('canvasArea').ondrop = e => { e.preventDefault(); $('dropZone').classList.remove('active'); const f = e.dataTransfer.files[0]; if (f?.type.startsWith('image/')) loadImage(f); };

$('applyBtn').onclick = applyEffect;
$('downloadBtn').onclick = () => { if (!state.processed) return; const a = document.createElement('a'); a.download = `madpixels-${Date.now()}.png`; a.href = canvas.toDataURL('image/png'); a.click(); };

$('toggle').onclick = () => {
    const on = $('toggle').classList.toggle('on');
    $('labelOriginal').classList.toggle('active', !on);
    $('labelProcessed').classList.toggle('active', on);
    display(on ? state.processed : state.original);
};

// Init
generateGallery();
renderEffects();
renderSettings();
</script>
</body>
</html>
