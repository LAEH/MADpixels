<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MADpixels</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@700&family=Archivo+Black&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; height: 100dvh; overflow: hidden; overscroll-behavior: none; }
        body { font-family: 'Space Grotesk', -apple-system, sans-serif; background: #fff; color: #000; }

        .app { height: 100%; display: flex; flex-direction: column; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0; }

        header { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; flex-shrink: 0; }

        .logo { font-family: 'Archivo Black', sans-serif; font-size: 16px; letter-spacing: -1px; display: flex; align-items: center; gap: 2px; }
        .logo-box { border: 3px solid #000; padding: 3px 5px; line-height: 1; transition: transform 0.2s; }
        .logo-box:hover { transform: rotate(-2deg); }
        .logo-emoji { font-size: 20px; margin-left: 4px; animation: wiggle 2s infinite; }

        @keyframes wiggle { 0%,100% { transform: rotate(0); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }

        .mode-toggle { display: flex; background: #000; border-radius: 24px; padding: 3px; gap: 2px; }
        .mode-btn { padding: 8px 14px; border: none; background: transparent; font-family: 'Space Grotesk', sans-serif; font-size: 12px; font-weight: 700; color: #666; border-radius: 20px; cursor: pointer; transition: all 0.2s; }
        .mode-btn.active { background: #fff; color: #000; }

        .header-right { display: flex; align-items: center; gap: 10px; }
        .score-wrap { text-align: center; min-width: 44px; }
        .score { font-family: 'Archivo Black', sans-serif; font-size: 24px; color: #000; transition: transform 0.2s; }
        .score.pop { animation: scorePop 0.3s; }
        @keyframes scorePop { 50% { transform: scale(1.3); } }
        .streak { font-size: 10px; color: #888; white-space: nowrap; }
        .streak.hot { color: #ff3366; font-weight: 700; animation: pulse 0.5s infinite; }

        .icon-btn { width: 38px; height: 38px; border: 3px solid #000; background: #fff; color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s; box-shadow: 3px 3px 0 #000; }
        .icon-btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 #000; }
        .icon-btn svg { width: 16px; height: 16px; }

        .main-area { flex: 1; min-height: 0; display: flex; align-items: center; justify-content: center; padding: 8px 12px; }

        .grid-container { position: relative; border-radius: 16px; overflow: hidden; box-shadow: 6px 6px 0 #000; border: 4px solid #000; transition: transform 0.3s; }
        .grid-container.shake { animation: gridShake 0.4s; }
        @keyframes gridShake { 0%,100% { transform: translateX(0); } 20%,60% { transform: translateX(-6px); } 40%,80% { transform: translateX(6px); } }

        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; background: #000; }

        .grid-cell { aspect-ratio: 1; background-size: cover; background-position: center; transition: transform 0.2s, opacity 0.2s; }
        .grid-cell.missing { background: linear-gradient(135deg, #ff3366, #ff6b3d, #ffc107, #ff3366); background-size: 300% 300%; animation: gradientMove 2s ease infinite; display: flex; align-items: center; justify-content: center; }
        .grid-cell.missing::after { content: '?'; font-family: 'Archivo Black', sans-serif; font-size: 28px; color: #fff; text-shadow: 2px 2px 0 rgba(0,0,0,0.3); animation: bounce 1s infinite; }
        @keyframes gradientMove { 0%,100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

        .grid-cell.correct { animation: cellPop 0.4s; }
        @keyframes cellPop { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }

        .canvas-container { border-radius: 16px; overflow: hidden; box-shadow: 6px 6px 0 #000; border: 4px solid #000; max-width: calc(100% - 24px); max-height: 100%; }
        .canvas-container canvas { display: block; max-width: 100%; max-height: 100%; }

        .controls { flex-shrink: 0; padding: 8px 12px 12px; display: flex; flex-direction: column; gap: 10px; }

        .game-controls .prompt { text-align: center; font-size: 32px; min-height: 40px; line-height: 40px; }
        .game-controls .prompt.correct { animation: promptPop 0.4s; }
        .game-controls .prompt.wrong { animation: shake 0.3s; }
        @keyframes promptPop { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .choices { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .choice { aspect-ratio: 1; border-radius: 14px; border: 4px solid #000; background-size: cover; background-position: center; cursor: pointer; transition: all 0.12s; box-shadow: 4px 4px 0 #000; }
        .choice:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #000; }
        .choice.wrong { border-color: #ff3366; box-shadow: 4px 4px 0 #ff3366; animation: shake 0.3s; opacity: 0.3; transform: scale(0.95); }
        .choice.correct { border-color: #00cc66; box-shadow: 0 0 0 4px #00cc66, 0 0 20px #00cc66; transform: scale(1.1); z-index: 10; }
        .choice.disabled { pointer-events: none; opacity: 0.25; }

        @keyframes shake { 0%,100% { transform: translateX(0); } 20%,60% { transform: translateX(-4px); } 40%,80% { transform: translateX(4px); } }

        .edit-controls .slider-row { display: flex; flex-direction: column; gap: 4px; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; }
        .slider-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #888; }
        .slider-value { font-size: 11px; font-weight: 700; color: #000; }

        input[type="range"] { -webkit-appearance: none; width: 100%; height: 40px; background: transparent; margin: 0; }
        input[type="range"]::-webkit-slider-runnable-track { height: 8px; background: #e0e0e0; border-radius: 4px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: #000; border-radius: 50%; margin-top: -8px; box-shadow: 2px 2px 0 rgba(0,0,0,0.2); }

        .btn-row { display: flex; gap: 8px; }
        .action-btn { flex: 1; height: 48px; border: 3px solid #000; border-radius: 24px; background: #000; color: #fff; font-family: 'Space Grotesk', sans-serif; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; box-shadow: 3px 3px 0 rgba(0,0,0,0.3); transition: all 0.15s; }
        .action-btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 rgba(0,0,0,0.3); }
        .action-btn.outline { background: #fff; color: #000; }

        .effect-select { display: flex; gap: 6px; }
        .effect-btn { flex: 1; padding: 10px; border: 3px solid #e0e0e0; background: #fff; font-size: 18px; border-radius: 12px; cursor: pointer; transition: all 0.15s; }
        .effect-btn.active { border-color: #000; background: #000; transform: scale(1.05); box-shadow: 3px 3px 0 rgba(0,0,0,0.3); }

        .hidden { display: none !important; }

        .welcome { position: fixed; inset: 0; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 32px; z-index: 100; padding: 24px; }
        .welcome-title { font-family: 'Archivo Black', sans-serif; font-size: 24px; letter-spacing: -1px; display: flex; align-items: center; gap: 4px; animation: fadeInUp 0.6s; }
        .welcome-title .logo-box { border: 4px solid #000; padding: 8px 10px; box-shadow: 4px 4px 0 #000; }
        .welcome-title .logo-emoji { font-size: 32px; margin-left: 8px; }
        .welcome-sub { font-size: 15px; color: #666; text-align: center; max-width: 260px; line-height: 1.6; animation: fadeInUp 0.6s 0.1s both; }
        .choose-btn { width: 100%; max-width: 260px; height: 56px; border: 3px solid #000; border-radius: 28px; background: #000; color: #fff; font-family: 'Space Grotesk', sans-serif; font-size: 15px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; box-shadow: 4px 4px 0 rgba(0,0,0,0.3); transition: all 0.15s; animation: fadeInUp 0.6s 0.2s both; }
        .choose-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 rgba(0,0,0,0.3); }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        canvas.gl { display: none; }

        .confetti { position: fixed; pointer-events: none; z-index: 1000; }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <span class="logo"><span class="logo-box">MAD</span><span class="logo-box">pixels</span><span class="logo-emoji">üß©</span></span>
            <div class="mode-toggle">
                <button class="mode-btn active" id="gameModeBtn">üéÆ Game</button>
                <button class="mode-btn" id="editModeBtn">‚ú® Edit</button>
            </div>
            <div class="header-right">
                <div class="score-wrap">
                    <div class="score" id="score">0</div>
                    <div class="streak" id="streak"></div>
                </div>
                <button class="icon-btn" id="newPhotoBtn">
                    <svg fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
            </div>
        </header>

        <div class="main-area">
            <div class="grid-container" id="gameArea">
                <div class="grid" id="grid"></div>
            </div>
            <div class="canvas-container hidden" id="editArea">
                <canvas id="canvas"></canvas>
            </div>
        </div>

        <div class="controls game-controls" id="gameControls">
            <div class="prompt" id="prompt"></div>
            <div class="choices" id="choices"></div>
        </div>

        <div class="controls edit-controls hidden" id="editControls">
            <div class="effect-select">
                <button class="effect-btn" data-effect="none">üì∑</button>
                <button class="effect-btn" data-effect="disperse">üí•</button>
                <button class="effect-btn" data-effect="shuffle">üîÄ</button>
                <button class="effect-btn active" data-effect="both">üåÄ</button>
            </div>
            <div class="slider-row">
                <div class="slider-header">
                    <span class="slider-label">Block Size</span>
                    <span class="slider-value" id="blockValue">32</span>
                </div>
                <input type="range" id="blockSlider" min="4" max="64" value="32" step="4">
            </div>
            <div class="slider-row">
                <div class="slider-header">
                    <span class="slider-label">Intensity</span>
                    <span class="slider-value" id="disperseValue">50</span>
                </div>
                <input type="range" id="disperseSlider" min="0" max="100" value="50" step="5">
            </div>
            <div class="btn-row">
                <button class="action-btn outline" id="shuffleBtn">üé≤ Random</button>
                <button class="action-btn" id="downloadBtn">üíæ Save</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept="image/*" multiple style="display:none">
    <canvas id="glCanvas" class="gl"></canvas>

    <div class="welcome" id="welcome">
        <div class="welcome-title"><span class="logo-box">MAD</span><span class="logo-box">pixels</span><span class="logo-emoji">üß©</span></div>
        <div class="welcome-sub">üì∏ Pick your photos<br>üîç Find the missing piece<br>üî• Build your streak</div>
        <button class="choose-btn" id="chooseBtn">üì± Choose Photos</button>
    </div>

<script>
const $ = id => document.getElementById(id);
const GRID = 5, TOTAL = 25, NEXT_DELAY = 400, PER_IMG = 3;

class GPU {
    constructor() {
        this.c = $('glCanvas');
        this.gl = this.c.getContext('webgl2') || this.c.getContext('webgl');
        this.ok = !!this.gl;
        if (this.ok) this.init();
    }
    init() {
        const gl = this.gl;
        const vs = gl.createShader(gl.VERTEX_SHADER);
        gl.shaderSource(vs, 'attribute vec2 p,t;varying vec2 v;void main(){gl_Position=vec4(p,0,1);v=t;}');
        gl.compileShader(vs);
        const fs = gl.createShader(gl.FRAGMENT_SHADER);
        gl.shaderSource(fs, 'precision highp float;varying vec2 v;uniform sampler2D i;uniform vec2 r;uniform float s,d;float h(vec2 p){return fract(sin(dot(p,vec2(127.1,311.7)))*43758.5453+d);}void main(){float m=max(r.x,r.y)*s/4.;float u1=max(.0001,h(v*r)),u2=h(v*r+vec2(1,0));vec2 n=vec2(sqrt(-2.*log(u1))*cos(6.28318*u2),sqrt(-2.*log(u1))*sin(6.28318*u2))*m/r;gl_FragColor=texture2D(i,clamp(v+n,0.,1.));}');
        gl.compileShader(fs);
        this.p = gl.createProgram();
        gl.attachShader(this.p, vs); gl.attachShader(this.p, fs); gl.linkProgram(this.p);
        this.pb = gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER, this.pb);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]), gl.STATIC_DRAW);
        this.tb = gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER, this.tb);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([0,1,1,1,0,0,0,0,1,1,1,0]), gl.STATIC_DRAW);
    }
    process(img, spread, seed) {
        const gl = this.gl, w = img.width, h = img.height;
        this.c.width = w; this.c.height = h;
        gl.viewport(0, 0, w, h); gl.useProgram(this.p);
        const tex = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, tex);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);
        gl.bindBuffer(gl.ARRAY_BUFFER, this.pb);
        const pL = gl.getAttribLocation(this.p, 'p');
        gl.enableVertexAttribArray(pL); gl.vertexAttribPointer(pL, 2, gl.FLOAT, false, 0, 0);
        gl.bindBuffer(gl.ARRAY_BUFFER, this.tb);
        const tL = gl.getAttribLocation(this.p, 't');
        gl.enableVertexAttribArray(tL); gl.vertexAttribPointer(tL, 2, gl.FLOAT, false, 0, 0);
        gl.uniform1i(gl.getUniformLocation(this.p, 'i'), 0);
        gl.uniform2f(gl.getUniformLocation(this.p, 'r'), w, h);
        gl.uniform1f(gl.getUniformLocation(this.p, 's'), spread);
        gl.uniform1f(gl.getUniformLocation(this.p, 'd'), seed);
        gl.drawArrays(gl.TRIANGLES, 0, 6);
        const px = new Uint8Array(w * h * 4);
        gl.readPixels(0, 0, w, h, gl.RGBA, gl.UNSIGNED_BYTE, px);
        const flip = new Uint8ClampedArray(px.length);
        for (let y = 0; y < h; y++) flip.set(px.subarray((h-1-y)*w*4, (h-y)*w*4), y*w*4);
        gl.deleteTexture(tex);
        return new ImageData(flip, w, h);
    }
}

const gpu = new GPU();
const canvas = $('canvas'), ctx = canvas.getContext('2d', { willReadFrequently: true });

let mode = 'game', images = [], imgIdx = 0, puzzleCount = 0;
let origImg = null, origData = null;
let blocks = [], cleanBlocks = [], blockURLs = [], cleanURLs = [];
let missing = -1, correct = -1, correctChoice = -1, choices = [];
let score = 0, streak = 0, best = 0, answered = false;
let blockSize = 32, dispersion = 50, seed = Math.random() * 1000, effect = 'both';

function loadImages(files) {
    images = []; imgIdx = 0; puzzleCount = 0;
    let loaded = 0;
    [...files].forEach((f, i) => {
        const r = new FileReader();
        r.onload = e => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                c.width = c.height = 500;
                const cx = c.getContext('2d');
                const s = Math.max(500/img.width, 500/img.height);
                cx.drawImage(img, (500-img.width*s)/2, (500-img.height*s)/2, img.width*s, img.height*s);
                images[i] = { canvas: c, data: cx.getImageData(0,0,500,500) };
                if (++loaded === files.length) {
                    for (let j = images.length-1; j > 0; j--) { const k = ~~(Math.random()*(j+1)); [images[j],images[k]] = [images[k],images[j]]; }
                    setImage(0);
                    $('welcome').classList.add('hidden');
                }
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(f);
    });
}

function setImage(i) {
    if (!images.length) return;
    imgIdx = i % images.length;
    puzzleCount = 0;
    origImg = images[imgIdx].canvas;
    origData = images[imgIdx].data;
    seed = Math.random() * 1000;
    mode === 'game' ? (extractBlocks(), newPuzzle()) : applyEdit();
}

function extractBlocks() {
    blocks = []; cleanBlocks = []; blockURLs = []; cleanURLs = [];
    const sz = origImg.width / GRID;
    for (let i = 0; i < TOTAL; i++) {
        const x = (i % GRID) * sz, y = ~~(i / GRID) * sz;
        const clean = document.createElement('canvas');
        clean.width = clean.height = sz;
        clean.getContext('2d').drawImage(origImg, x, y, sz, sz, 0, 0, sz, sz);
        cleanBlocks.push(clean);
        cleanURLs.push(clean.toDataURL());

        const block = document.createElement('canvas');
        block.width = block.height = sz;
        const bx = block.getContext('2d');
        bx.drawImage(origImg, x, y, sz, sz, 0, 0, sz, sz);
        if (gpu.ok) {
            const dispersed = gpu.process(bx.getImageData(0,0,sz,sz), 0.2, seed*(i+1)*7.31+Math.sin(i*13.7)*1000);
            bx.putImageData(dispersed, 0, 0);
        }
        blocks.push(block);
        blockURLs.push(block.toDataURL());
    }
}

function shuffle(a) { const r=[...a]; for(let i=r.length-1;i>0;i--){const j=~~(Math.random()*(i+1));[r[i],r[j]]=[r[j],r[i]];} return r; }

function newPuzzle() {
    answered = false;
    $('prompt').textContent = '';
    $('prompt').className = 'prompt';
    missing = ~~(Math.random() * TOTAL);
    correct = missing;
    const wrong = [];
    while (wrong.length < 3) { const n = ~~(Math.random()*TOTAL); if (n !== correct && !wrong.includes(n)) wrong.push(n); }
    choices = shuffle([correct, ...wrong]);
    correctChoice = choices.indexOf(correct);
    renderGrid();
    renderChoices();
}

function renderGrid() {
    const grid = $('grid'), wrap = document.querySelector('.main-area');
    const maxSz = Math.min(wrap.clientWidth - 24, wrap.clientHeight - 16);
    const cellSz = ~~(maxSz / GRID);
    grid.style.width = grid.style.height = cellSz * GRID + (GRID-1) * 2 + 'px';
    grid.innerHTML = '';
    for (let i = 0; i < TOTAL; i++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.style.cssText = `width:${cellSz}px;height:${cellSz}px;`;
        if (i === missing && !answered) cell.classList.add('missing');
        else cell.style.backgroundImage = `url(${blockURLs[i]})`;
        grid.appendChild(cell);
    }
}

function renderChoices() {
    const c = $('choices');
    c.innerHTML = '';
    choices.forEach((idx, i) => {
        const el = document.createElement('div');
        el.className = 'choice';
        el.style.backgroundImage = `url(${cleanURLs[idx]})`;
        el.onclick = () => pick(i);
        c.appendChild(el);
    });
}

function pick(i) {
    if (answered) return;
    answered = true;
    const els = $('choices').children, cells = $('grid').children;
    [...els].forEach(e => e.classList.add('disabled'));

    if (i === correctChoice) {
        score++; streak++;
        if (streak > best) best = streak;
        els[i].classList.remove('disabled');
        els[i].classList.add('correct');
        cells[missing].classList.remove('missing');
        cells[missing].style.backgroundImage = `url(${blockURLs[correct]})`;
        cells[missing].classList.add('correct');
        $('prompt').textContent = streak > 2 ? `üî• ${streak}` : '‚ú®';
        $('prompt').className = 'prompt correct';
        $('score').classList.add('pop');
        setTimeout(() => $('score').classList.remove('pop'), 300);
        if (streak >= 5 && streak % 5 === 0) confetti();
        puzzleCount++;
        setTimeout(() => images.length > 1 && puzzleCount >= PER_IMG ? setImage(imgIdx+1) : newPuzzle(), NEXT_DELAY);
    } else {
        streak = 0;
        answered = false;
        els[i].classList.add('wrong');
        $('prompt').textContent = '‚úó';
        $('prompt').className = 'prompt wrong';
        $('gameArea').classList.add('shake');
        setTimeout(() => $('gameArea').classList.remove('shake'), 400);
        setTimeout(() => {
            els[i].classList.add('disabled');
            [...els].forEach((e, j) => { if (j !== i && !e.classList.contains('wrong')) e.classList.remove('disabled'); });
        }, 300);
    }
    updateScore();
}

function updateScore() {
    $('score').textContent = score;
    const s = $('streak');
    if (streak > 2) { s.textContent = `üî• ${streak}`; s.className = 'streak hot'; }
    else if (best > 2) { s.textContent = `best ${best}`; s.className = 'streak'; }
    else s.textContent = '';
}

function confetti() {
    for (let i = 0; i < 30; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.textContent = ['üéâ','‚ú®','‚≠ê','üî•'][~~(Math.random()*4)];
        c.style.cssText = `left:${Math.random()*100}%;top:-20px;font-size:${16+Math.random()*16}px;`;
        document.body.appendChild(c);
        c.animate([
            { transform: 'translateY(0) rotate(0)', opacity: 1 },
            { transform: `translateY(${window.innerHeight+50}px) rotate(${Math.random()*720-360}deg)`, opacity: 0 }
        ], { duration: 1500+Math.random()*1000, easing: 'ease-out' }).onfinish = () => c.remove();
    }
}

function binShuffle(data, sz, s) {
    const w = data.width, d = new Uint8ClampedArray(data.data), o = new Uint8ClampedArray(d.length);
    const bx = ~~(w/sz), by = ~~(w/sz), t = bx*by;
    const idx = [...Array(t).keys()];
    const rng = x => { x = Math.sin(x)*10000; return x - ~~x; };
    for (let i = t-1; i > 0; i--) { s = rng(s+i); const j = ~~(s*(i+1)); [idx[i],idx[j]] = [idx[j],idx[i]]; }
    for (let i = 0; i < t; i++) {
        const sx = (idx[i]%bx)*sz, sy = ~~(idx[i]/bx)*sz, dx = (i%bx)*sz, dy = ~~(i/bx)*sz;
        for (let y = 0; y < sz; y++) for (let x = 0; x < sz; x++) {
            const si = ((sy+y)*w+sx+x)*4, di = ((dy+y)*w+dx+x)*4;
            o[di]=d[si]; o[di+1]=d[si+1]; o[di+2]=d[si+2]; o[di+3]=d[si+3];
        }
    }
    return new ImageData(o, w, w);
}

function applyEdit() {
    if (!origData) return;
    let r = new ImageData(new Uint8ClampedArray(origData.data), origData.width, origData.height);
    if (effect === 'shuffle' || effect === 'both') r = binShuffle(r, blockSize, seed);
    if ((effect === 'disperse' || effect === 'both') && dispersion > 0 && gpu.ok) r = gpu.process(r, dispersion/100, seed);
    canvas.width = canvas.height = r.width;
    ctx.putImageData(r, 0, 0);
}

function setMode(m) {
    mode = m;
    $('gameModeBtn').classList.toggle('active', m === 'game');
    $('editModeBtn').classList.toggle('active', m === 'edit');
    $('gameArea').classList.toggle('hidden', m !== 'game');
    $('editArea').classList.toggle('hidden', m !== 'edit');
    $('gameControls').classList.toggle('hidden', m !== 'game');
    $('editControls').classList.toggle('hidden', m !== 'edit');
    if (origImg) m === 'game' ? (extractBlocks(), newPuzzle()) : applyEdit();
}

$('chooseBtn').onclick = $('newPhotoBtn').onclick = () => $('fileInput').click();
$('fileInput').onchange = e => { if (e.target.files.length) { loadImages(e.target.files); score = streak = 0; updateScore(); } };
$('gameModeBtn').onclick = () => setMode('game');
$('editModeBtn').onclick = () => setMode('edit');

let editTimer;
$('blockSlider').oninput = e => { blockSize = +e.target.value; $('blockValue').textContent = blockSize; clearTimeout(editTimer); editTimer = setTimeout(applyEdit, 50); };
$('disperseSlider').oninput = e => { dispersion = +e.target.value; $('disperseValue').textContent = dispersion; clearTimeout(editTimer); editTimer = setTimeout(applyEdit, 50); };
$('shuffleBtn').onclick = () => { seed = Math.random() * 1000; applyEdit(); };
$('downloadBtn').onclick = () => { const a = document.createElement('a'); a.download = `madpixels-${Date.now()}.png`; a.href = canvas.toDataURL(); a.click(); };

document.querySelectorAll('.effect-btn').forEach(b => b.onclick = () => {
    document.querySelectorAll('.effect-btn').forEach(x => x.classList.remove('active'));
    b.classList.add('active');
    effect = b.dataset.effect;
    applyEdit();
});

window.onresize = () => { if (origImg && mode === 'game') renderGrid(); };
</script>
</body>
</html>
