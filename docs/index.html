<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MADpixels</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'Space Grotesk', -apple-system, sans-serif;
            background: #fff;
            color: #000;
        }

        .app {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            flex-shrink: 0;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .score {
            font-size: 16px;
            font-weight: 700;
            color: #666;
        }

        .header-btns {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border: 2px solid #000;
            background: #fff;
            color: #000;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .icon-btn:active { background: #000; color: #fff; }
        .icon-btn svg { width: 20px; height: 20px; }

        .grid-wrap {
            flex: 1;
            min-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
        }

        .grid-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 1px;
            background: #e0e0e0;
        }

        .grid-cell {
            aspect-ratio: 1;
            background-size: cover;
            background-position: center;
        }

        .grid-cell.missing {
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-cell.missing::after {
            content: '?';
            font-size: 24px;
            font-weight: 700;
            color: #ccc;
        }

        .grid-cell.correct {
            animation: flash-green 0.5s;
        }

        @keyframes flash-green {
            0%, 100% { filter: none; }
            50% { filter: brightness(1.5) saturate(0.5) sepia(1) hue-rotate(70deg); }
        }

        .controls {
            flex-shrink: 0;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .prompt {
            text-align: center;
            font-size: 15px;
            font-weight: 600;
            color: #666;
        }

        .choices {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .choice {
            aspect-ratio: 1;
            border-radius: 12px;
            border: 3px solid #e0e0e0;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: border-color 0.15s, transform 0.15s;
        }
        .choice:active { transform: scale(0.95); }
        .choice.wrong {
            border-color: #ff4444;
            animation: shake 0.3s;
        }
        .choice.correct {
            border-color: #44cc44;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        .action-row {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            flex: 1;
            height: 56px;
            border: none;
            border-radius: 28px;
            background: #000;
            color: #fff;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
        }
        .action-btn:active { opacity: 0.85; }
        .action-btn.outline {
            background: #fff;
            color: #000;
            border: 2px solid #000;
        }

        .hidden { display: none !important; }

        .welcome {
            position: fixed;
            inset: 0;
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 48px;
            z-index: 100;
            padding: 32px;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .welcome-sub {
            font-size: 16px;
            color: #666;
            text-align: center;
            max-width: 280px;
            line-height: 1.5;
        }

        .choose-btn {
            width: 100%;
            max-width: 280px;
            height: 64px;
            border: none;
            border-radius: 32px;
            background: #000;
            color: #fff;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
        }
        .choose-btn:active { opacity: 0.85; }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <span class="logo">MADpixels</span>
            <span class="score" id="score">0 / 0</span>
            <div class="header-btns">
                <button class="icon-btn" id="newPhotoBtn" title="New Photo">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                    </svg>
                </button>
            </div>
        </header>

        <div class="grid-wrap">
            <div class="grid-container">
                <div class="grid" id="grid"></div>
            </div>
        </div>

        <div class="controls">
            <div class="prompt" id="prompt">Find the missing piece</div>
            <div class="choices" id="choices"></div>
            <div class="action-row">
                <button class="action-btn" id="nextBtn">Next Puzzle</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept="image/*" style="display:none">

    <div class="welcome" id="welcome">
        <div class="welcome-title">MADpixels</div>
        <div class="welcome-sub">Find the missing piece. Test your eye for detail.</div>
        <button class="choose-btn" id="chooseBtn">Choose Photo</button>
    </div>

<script>
// State
let originalImage = null;
let blocks = []; // 64 block canvases
let missingIndex = -1;
let correctIndex = -1;
let choices = []; // indices of blocks shown as choices
let score = 0;
let total = 0;
let answered = false;

const GRID_SIZE = 8;
const TOTAL_BLOCKS = GRID_SIZE * GRID_SIZE;

const $ = id => document.getElementById(id);

function loadImage(file) {
    const reader = new FileReader();
    reader.onload = e => {
        const img = new Image();
        img.onload = () => {
            // Resize to 512x512 for clean 8x8 grid (64px per block)
            const size = 512;
            const c = document.createElement('canvas');
            c.width = size; c.height = size;
            const cx = c.getContext('2d');

            // Cover fit
            const scale = Math.max(size / img.width, size / img.height);
            const w = img.width * scale;
            const h = img.height * scale;
            cx.drawImage(img, (size - w) / 2, (size - h) / 2, w, h);

            originalImage = c;
            extractBlocks();
            score = 0;
            total = 0;
            updateScore();
            newPuzzle();

            $('welcome').classList.add('hidden');
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function extractBlocks() {
    blocks = [];
    const blockSize = originalImage.width / GRID_SIZE;
    const ctx = originalImage.getContext('2d');

    for (let i = 0; i < TOTAL_BLOCKS; i++) {
        const x = (i % GRID_SIZE) * blockSize;
        const y = Math.floor(i / GRID_SIZE) * blockSize;

        const blockCanvas = document.createElement('canvas');
        blockCanvas.width = blockSize;
        blockCanvas.height = blockSize;
        const blockCtx = blockCanvas.getContext('2d');
        blockCtx.drawImage(originalImage, x, y, blockSize, blockSize, 0, 0, blockSize, blockSize);

        blocks.push(blockCanvas);
    }
}

function newPuzzle() {
    answered = false;
    $('prompt').textContent = 'Find the missing piece';
    $('prompt').style.color = '#666';

    // Pick random missing block
    missingIndex = Math.floor(Math.random() * TOTAL_BLOCKS);

    // Create choices: 1 correct + 3 wrong
    const wrongChoices = [];
    while (wrongChoices.length < 3) {
        const idx = Math.floor(Math.random() * TOTAL_BLOCKS);
        if (idx !== missingIndex && !wrongChoices.includes(idx)) {
            wrongChoices.push(idx);
        }
    }

    choices = [missingIndex, ...wrongChoices];
    // Shuffle choices
    for (let i = choices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [choices[i], choices[j]] = [choices[j], choices[i]];
    }
    correctIndex = choices.indexOf(missingIndex);

    renderGrid();
    renderChoices();
}

function renderGrid() {
    const grid = $('grid');
    grid.innerHTML = '';

    // Calculate cell size based on available space
    const wrap = document.querySelector('.grid-wrap');
    const maxSize = Math.min(wrap.clientWidth - 32, wrap.clientHeight - 16);
    const cellSize = Math.floor(maxSize / GRID_SIZE);

    grid.style.width = cellSize * GRID_SIZE + (GRID_SIZE - 1) + 'px';
    grid.style.height = cellSize * GRID_SIZE + (GRID_SIZE - 1) + 'px';

    for (let i = 0; i < TOTAL_BLOCKS; i++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.style.width = cellSize + 'px';
        cell.style.height = cellSize + 'px';

        if (i === missingIndex && !answered) {
            cell.classList.add('missing');
        } else {
            cell.style.backgroundImage = `url(${blocks[i].toDataURL()})`;
        }

        grid.appendChild(cell);
    }
}

function renderChoices() {
    const container = $('choices');
    container.innerHTML = '';

    choices.forEach((blockIdx, i) => {
        const choice = document.createElement('div');
        choice.className = 'choice';
        choice.style.backgroundImage = `url(${blocks[blockIdx].toDataURL()})`;

        if (!answered) {
            choice.onclick = () => selectChoice(i);
        }

        container.appendChild(choice);
    });
}

function selectChoice(idx) {
    if (answered) return;
    answered = true;
    total++;

    const choiceEls = $('choices').children;
    const gridCells = $('grid').children;

    if (idx === correctIndex) {
        // Correct!
        score++;
        choiceEls[idx].classList.add('correct');
        gridCells[missingIndex].classList.remove('missing');
        gridCells[missingIndex].style.backgroundImage = `url(${blocks[missingIndex].toDataURL()})`;
        gridCells[missingIndex].classList.add('correct');
        $('prompt').textContent = 'Correct!';
        $('prompt').style.color = '#44cc44';
    } else {
        // Wrong
        choiceEls[idx].classList.add('wrong');
        choiceEls[correctIndex].classList.add('correct');
        // Show the correct piece in grid
        gridCells[missingIndex].classList.remove('missing');
        gridCells[missingIndex].style.backgroundImage = `url(${blocks[missingIndex].toDataURL()})`;
        $('prompt').textContent = 'Wrong! The correct piece is highlighted.';
        $('prompt').style.color = '#ff4444';
    }

    updateScore();
}

function updateScore() {
    $('score').textContent = `${score} / ${total}`;
}

// Events
$('chooseBtn').onclick = () => $('fileInput').click();
$('newPhotoBtn').onclick = () => $('fileInput').click();
$('fileInput').onchange = e => e.target.files[0] && loadImage(e.target.files[0]);
$('nextBtn').onclick = () => {
    if (originalImage) newPuzzle();
};

// Resize handler
window.addEventListener('resize', () => {
    if (originalImage) renderGrid();
});
</script>
</body>
</html>
